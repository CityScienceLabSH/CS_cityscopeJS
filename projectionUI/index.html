<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <style type="text/css">
    	body {
    		background-color: #000;
    	}
    	svg {
    		width: 100%;
    		height:800px;
    	}
    </style>
    <title>projection</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body id='body'>
	<svg id='svg'></svg>

<script type="text/javascript">
	var svg = d3.select("#svg")

	var x0 = 0;
	var y0 = 0;

	var dataset = [100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100]
	var dataset2 = [10,10,10,10,10,10,10,10,10,10,
					10,10,10,10,10,10,10,10,10,10,
					10,10,10,10,10,10,10,10,10,10,
					10,10,10,10,10,10,10,10,10,10,
					10,10,10,10,10,10,10,10,10,10,
					10,10,10,10,10,10,10,10,10,10,
					10,10,10,10,10,10,10,10,10,10,
					10,10,10,10,10,10,10,10,10,10,
					10,10,10,10,10,10,10,10,10,10,
					10,10,10,10,10,10,10,10,10,10]

	var drag = d3.drag().subject(this)
    .on('start',function (d) {
        if (d.x1){
            d.x1 =  d3.event.x - d.xt;
            d.y1 =  d3.event.y - d.yt;
        }else{
            d.x1 = d3.event.x;
            d.y1 = d3.event.y;
        }
    })
    .on('drag',function(d){
        d3.select(this).selectAll('rect')
        .attr("transform", "translate(" + (d3.event.x - d.x1)  + "," + (d3.event.y - d.y1) + ")");

        d.xt = d3.event.x - d.x1;
        d.yt = d3.event.y - d.y1;
    });


	var rectGroup = svg.append('g').attr('id','g1')
	rectGroup.selectAll("#g1")
		  .data(dataset)
		  .enter()
		  .append("rect")
		.attr("id",function(d,i){ return 'rect'+i })
		.attr("x",function(d,i){//每个矩形的起始x坐标
				return x0+(i%4) * 150;
		  })//每个矩形的起始x坐标
		.attr("y",function(d,i){//每个矩形的起始y坐标
				return y0+parseInt(i/4) * 150;
		  })
		.attr("width",150)
		.attr("height",150)//每个矩形的高度
		.attr("fill","white")//填充颜色
		.attr("stroke","black")//填充颜色
		

	var rectGroup2 = svg.append('g').attr('id','g2')

	rectGroup2.selectAll('#g2')
		.data(dataset2)
		  .enter()
		.append("rect")
		.attr("x",function(d,i){//每个矩形的起始x坐标
				return x0+150+(i%10) * 15;
		  })//每个矩形的起始x坐标
		.attr("y",function(d,i){//每个矩形的起始y坐标
				return y0+450+parseInt(i/10) * 15;
		  })
		.attr("width",15)
		.attr("height",15)//每个矩形的高度
		.attr("fill","white")//填充颜色
		.attr("stroke","black")//填充颜色
	//rectGroup.call(drag);
		

	function dragmove(d) {
        d3.select(this).selectAll('rect')
            .attr("transform", "translate(" + (d3.event.x - d.x)  + "," + (d3.event.y - d.y) + ")");
    }

    //initial data
    // tmpData = [1, 4, 0, 3, 5, 2, 4, 0, 4, 5, 2, 5, 3, 4, 4, 0, 3, 4, 2, 3, 3, 4, 0, 4, 2, 1, 3, 2, 2, 2, 4, 0, 2, 4, 5, 1, 1, 3, 5, 1, 2, 4, 1, 4, 3, 5, 2, 0, 0, 0, 1, 2, 5, 5, 5, 5, 4, 1, 0, 0, 3, 3, 4, 5, 2, 5, 3, 2, 2, 2, 0, 3, 3, 1, 5, 3, 0, 5, 2, 1, 1, 4, 3, 2, 3, 3, 1, 1, 1, 1, 5, 1, 2, 0, 5, 4, 1, 5, 0, 1]

    mapList = ['icon/0000comercial.svg','icon/0001incubator.svg','icon/0011service.svg','icon/0101keylab.svg','icon/0111cocreation.svg','icon/1111startup.svg']

    let tableName = "CityScopeJS";

	let cityIOtableURL =
	  "https://cityio.media.mit.edu/api/table/" + tableName.toString();

    let interval = 1500;

	async function init() {
	  cityIOupdater();
	}

	function cityIOupdater() {
	  let cityIOdata;
	  let tmpData;
	  let recordData = 'initial';
	  //loop cityIO update recursively
	  setInterval(updateCityIO, interval);
	  //update grid if cityIO new data arrives

	  function compare(recordData,currentData){
	  	changeList = []
	  	for (var i=0; i<100; i++){
	  		if (recordData[i]!=currentData[i]){
	  			changeList.push(i)
	  		}
	  	}
	  	if (changeList.length){
	  		return changeList
	  	}
	  	else {
	  		return true
	  	}
	  }

	  async function updateCityIO() {
	    //get the data through promise
	    cityIOdata = await getCityIO(cityIOtableURL);
	    for (var i=0; i<100; i++) {
	    	if ((cityIOdata['grid'][i] == 1)||(cityIOdata['grid'][i] == 2)||(cityIOdata['grid'][i] == 3)||(cityIOdata['grid'][i] == 4)){
	    		cityIOdata['grid'][i] = 1
	    	}
	    	if ((cityIOdata['grid'][i] == 5)||(cityIOdata['grid'][i] == 6)){
	    		cityIOdata['grid'][i] = 2
	    	}
	    	if ((cityIOdata['grid'][i] == 7)||(cityIOdata['grid'][i] == 8)){
	    		cityIOdata['grid'][i] = 3
	    	}
	    	if ((cityIOdata['grid'][i] == 9)||(cityIOdata['grid'][i] == 10)||(cityIOdata['grid'][i] == 11)||(cityIOdata['grid'][i] == 12)){
	    		cityIOdata['grid'][i] = 4
	    	}
	    	if (cityIOdata['grid'][i] == 13){
	    		cityIOdata['grid'][i] = 5
	    	}
	    }
	    tmpData = cityIOdata['grid'];
	    if (recordData == 'initial') {
	    	for (var i=0; i<100; i++){
		    	var tmp = document.createElement('embed');
			    tmp.id = 'id'+i;
			    tmp.src=mapList[tmpData[i]];
			    tmp.width = '8px'
			    tmp.height = '8px'
			    tmp.style.position = "absolute";
			    num = 160+15*parseInt(i%10);
			    tmp.style.left = num+"px";
			    num = 460+15*parseInt(i/10);
			    tmp.style.top = num+"px"
			    document.getElementById('body').appendChild(tmp);
			    
		    }
		    recordData = tmpData;
	    }
	    else if (compare(recordData,tmpData)!=true){
	    	list = compare(recordData,tmpData)
	    	for (var i=0; i<list.length; i++){
			    tmp = document.getElementById('id'+list[i])
			    document.getElementById('body').removeChild(tmp);
			    var tmp = document.createElement('embed');
			    tmp.id = 'id'+list[i];
			    tmp.src=mapList[tmpData[list[i]]];
			    tmp.width = '8px'
			    tmp.height = '8px'
			    tmp.style.position = "absolute";
			    num = 160+15*parseInt(list[i]%10);
			    tmp.style.left = num+"px";
			    num = 460+15*parseInt(list[i]/10);
			    tmp.style.top = num+"px"
			    document.getElementById('body').appendChild(tmp);
			}
			recordData = tmpData;
	    }
	  }
	}


    function getCityIO(cityIOtableURL) {
	  // console.log("trying to fetch " + cityIOtableURL);
	  return fetch(cityIOtableURL)
	    .then(function(response) {
	      return response.json();
	    })
	    .then(function(cityIOdata) {
	      // console.log("got cityIO table at " + cityIOdata.meta.timestamp);
	      return cityIOdata;
	    });
	}


	init();
</script>
</body>
</html>